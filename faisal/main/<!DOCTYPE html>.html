<!DOCTYPE html>
 
<html>
    <head>
      <meta http-equiv="Cache-Control" content="no-cache">
      <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
      <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v4.0.1/dist/aframe-physics-system.min.js"></script>
      <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.0/dist/aframe-extras.min.js"></script>
      <script src="https://unpkg.com/aframe-teleport-controls@0.2.x/dist/aframe-teleport-controls.min.js"></script>
      <script src="https://unpkg.com/aframe-controller-cursor-component@0.2.x/dist/aframe-controller-cursor-component.min.js"></script>
      <script src="https://unpkg.com/super-hands@^3.0.1/dist/super-hands.min.js"></script>
      <script>
        var shallThrow = false;
var hasThrown = false;
var ball;
var lastPosition = new CANNON.Vec3(0, 0, 0);
var currentPosition = new CANNON.Vec3(0, 0, 0);
var hasPrepared = false;

function throwBall(delta) {
    hasThrown = true;
    hasPrepared = false;
    let velocity = currentPosition.vsub(lastPosition).scale(1/delta);
    ball.body.applyLocalImpulse(velocity.scale(50), new CANNON.Vec3(0, 0, 0));
}

AFRAME.registerComponent('throwing-hand', {
    dependencies: ['dynamic-body', 'vive-controls'],
    init: function () {
        this.el.addEventListener('triggerdown', function (e) {
            hasPrepared = true;
            console.log('triggerdown');
        });
        this.el.addEventListener('triggerup', function (e) {
            if (!hasThrown && hasPrepared) { shallThrow = true};
            console.log('triggerup');
        });
        this.el.addEventListener('menuup', function (e) { // restart
            hasThrown = false;
            hasPrepared = false;
            shallThrow = false;
            lastPosition = new CANNON.Vec3(0, 0, 0);
            currentPosition = new CANNON.Vec3(0, 0, 0);
        });

    },
    tick: function (uptime, delta) {
        let position = this.el.getAttribute('position');

        if (!hasThrown && ball && ball.body) {
            ball.body.velocity.set(0, 0, 0);
            ball.body.angularVelocity.set(0, 0, 0);
            ball.body.quaternion.set(0, 0, 0, 1);
            ball.body.position.set(position.x, position.y, position.z);
        }

        if (shallThrow && ball && ball.body) {
            shallThrow = false;
            currentPosition.copy(position);
            throwBall(delta / 1000.0);
        }

        lastPosition.copy(position);
    }
});

window.onload = function () {
    ball = document.getElementById('ball');

    //
    // make the ball not bounce when colliding with the ground or the bumpers
    //

    let world = document.querySelector('a-scene').systems['physics'].world;
    let groundMaterial = document.querySelector('[static-body]').body.material;
    let laneObjects = document.querySelectorAll(['static-body']);
    for (let i = 0; i < laneObjects.length; i++) {
        laneObjects[i].body.material = groundMaterial;
    }

    // create a contact material: ball vs ground/bumpers
    let contactMaterial = new CANNON.ContactMaterial(
        groundMaterial, ball.body.material, { restitution: 0.001 });
    world.addContactMaterial(contactMaterial);
};
      </script>

    </head>
 
  <body>
    
    <a-scene physics="debug: false; iterations: 20;">
      <a-entity id="right" vive-controls="hand: right" hand-controls="right" throwing-hand></a-entity>
      <a-entity id="left" vive-controls="hand: left" hand-controls="left"></a-entity>

      <a-sphere id="ball" radius="0.15" color="#afa" dynamic-body="mass: 50; linearDamping: 0.0001"></a-sphere>

      <a-cylinder radius="0.05" height="0.3" position="0 0.15 -5" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>

      <a-cylinder radius="0.05" height="0.3" position="-0.2 0.15 -5.2" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>
      <a-cylinder radius="0.05" height="0.3" position="0.2 0.15 -5.2" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>

      <a-cylinder radius="0.05" height="0.3" position="0 0.15 -5.4" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>
      <a-cylinder radius="0.05" height="0.3" position="-0.4 0.15 -5.4" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>
      <a-cylinder radius="0.05" height="0.3" position="0.4 0.15 -5.4" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>

      <a-cylinder radius="0.05" height="0.3" position="-0.2 0.15 -5.6" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>
      <a-cylinder radius="0.05" height="0.3" position="0.2 0.15 -5.6" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>
      <a-cylinder radius="0.05" height="0.3" position="-0.6 0.15 -5.6" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>
      <a-cylinder radius="0.05" height="0.3" position="0.6 0.15 -5.6" color="#ccc"
          dynamic-body="mass: 1"></a-cylinder>


      <a-box color="#aaa" width="0.25" height="0.2" depth="50" position="-1 0 -20"
          static-body></a-box>
      <a-box color="#aaa" width="0.25" height="0.2" depth="50" position="1 0 -20"
          static-body></a-box>
      <a-box color="#ccc" width="20" depth="50" height="1" position="0 -0.5 -20" static-body></a-box>

      <a-sky color="#101"></a-sky>
  </a-scene>



</body>
</html>